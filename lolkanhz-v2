local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- Bi·∫øn to√†n c·ª•c
local targetPlayer = nil
local isFlying = false
local flyConnection = nil
local wasFlyingBeforeDeath = false
local previousTarget = nil

-- T·∫°o GUI - ƒê·∫∂T NGO√ÄI H√ÄM ƒê·ªÇ KH√îNG B·ªä M·∫§T
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FlyAntGUI"
screenGui.Parent = player.PlayerGui

local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(0, 50, 0, 50)
toggleButton.Position = UDim2.new(0, 10, 0, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
toggleButton.Text = "üêú"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextSize = 20
toggleButton.Parent = screenGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 180, 0, 200)
mainFrame.Position = UDim2.new(0, 70, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = true
mainFrame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, 0, 0, 25)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(0, 80, 160)
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "FLY ANT - by lolkanhz"
title.Font = Enum.Font.GothamBold
title.TextSize = 12
title.Parent = mainFrame

local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(1, -10, 0, 20)
statusLabel.Position = UDim2.new(0, 5, 0, 30)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
statusLabel.Text = "ƒêang t·∫£i..."
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 10
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

local toggleFlyButton = Instance.new("TextButton")
toggleFlyButton.Name = "ToggleFly"
toggleFlyButton.Size = UDim2.new(1, -10, 0, 25)
toggleFlyButton.Position = UDim2.new(0, 5, 0, 55)
toggleFlyButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
toggleFlyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleFlyButton.Text = "B·∫¨T BAY"
toggleFlyButton.Font = Enum.Font.GothamBold
toggleFlyButton.TextSize = 11
toggleFlyButton.Parent = mainFrame

local playersFrame = Instance.new("ScrollingFrame")
playersFrame.Name = "PlayersFrame"
playersFrame.Size = UDim2.new(1, -10, 0, 90)
playersFrame.Position = UDim2.new(0, 5, 0, 85)
playersFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
playersFrame.BorderSizePixel = 0
playersFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
playersFrame.ScrollBarThickness = 4
playersFrame.Parent = mainFrame

-- H√†m M·ªû KH√ìA DI CHUY·ªÇN
local function unlockMovement()
    local character = player.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.PlatformStand = false -- QUAN TR·ªåNG: M·ªû KH√ìA DI CHUY·ªÇN
        end
    end
end

-- H√†m c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i
local function updatePlayerList()
    for _, child in ipairs(playersFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    local yOffset = 0
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            local playerButton = Instance.new("TextButton")
            playerButton.Name = otherPlayer.Name
            playerButton.Size = UDim2.new(1, 0, 0, 20)
            playerButton.Position = UDim2.new(0, 0, 0, yOffset)
            
            if targetPlayer == otherPlayer then
                playerButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
            else
                playerButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
            
            playerButton.BorderSizePixel = 0
            playerButton.TextColor3 = Color3.fromRGB(255, 255, 255)
            playerButton.Text = otherPlayer.Name
            playerButton.Font = Enum.Font.Gotham
            playerButton.TextSize = 9
            playerButton.Parent = playersFrame
            
            playerButton.MouseButton1Click:Connect(function()
                targetPlayer = otherPlayer
                statusLabel.Text = "Ch·ªçn: " .. otherPlayer.Name
                statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
                updatePlayerList()
            end)
            
            yOffset = yOffset + 22
        end
    end
    
    playersFrame.CanvasSize = UDim2.new(0, 0, 0, yOffset)
end

-- H√†m bay ƒë·∫øn target
local function flyToTarget()
    if not targetPlayer then 
        isFlying = false
        unlockMovement() -- M·ªû KH√ìA N·∫æU KH√îNG C√ì TARGET
        return 
    end
    
    local character = player.Character
    if not character then 
        isFlying = false
        return 
    end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    local targetCharacter = targetPlayer.Character
    if not targetCharacter then 
        isFlying = false
        unlockMovement()
        return 
    end
    
    local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
    local targetHumanoid = targetCharacter:FindFirstChild("Humanoid")
    
    if not targetRoot or not targetHumanoid or not rootPart or not humanoid then
        isFlying = false
        unlockMovement()
        return
    end
    
    -- KI·ªÇM TRA TARGET CH·∫æT - T·ª∞ ƒê·ªòNG T·∫ÆT BAY V√Ä M·ªû KH√ìA
    if targetHumanoid.Health <= 0 then
        isFlying = false
        unlockMovement()
        toggleFlyButton.Text = "B·∫¨T BAY"
        toggleFlyButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        statusLabel.Text = "Target ch·∫øt - ƒê√£ m·ªü kh√≥a"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        return
    end
    
    -- Bay ƒë·∫øn v·ªã tr√≠ tr√™n ƒë·∫ßu target
    local targetPosition = targetRoot.Position + Vector3.new(0, 6, 0)
    rootPart.CFrame = CFrame.new(targetPosition)
    humanoid.PlatformStand = true -- KH√ìA DI CHUY·ªÇN KHI ƒêANG BAY
    
    statusLabel.Text = "ƒêang bay: " .. targetPlayer.Name
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
end

-- X·ª≠ l√Ω khi ng∆∞·ªùi ch∆°i tham gia/r·ªùi ƒëi
local function onPlayerAdded(newPlayer)
    wait(1)
    updatePlayerList()
end

local function onPlayerRemoving(leavingPlayer)
    if targetPlayer == leavingPlayer then
        targetPlayer = nil
        isFlying = false
        unlockMovement() -- M·ªû KH√ìA KHI TARGET R·ªúI
        statusLabel.Text = "Target r·ªùi - ƒê√£ m·ªü kh√≥a"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        toggleFlyButton.Text = "B·∫¨T BAY"
        toggleFlyButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    end
    updatePlayerList()
end

-- Khi h·ªìi sinh
player.CharacterAdded:Connect(function(newCharacter)
    wait(2)
    
    -- LU√îN M·ªû KH√ìA DI CHUY·ªÇN KHI H·ªíI SINH
    unlockMovement()
    
    -- T·ª∞ ƒê·ªòNG KH√îI PH·ª§C n·∫øu tr∆∞·ªõc ƒë√≥ ƒëang bay
    if wasFlyingBeforeDeath and previousTarget then
        targetPlayer = previousTarget
        isFlying = true
        
        toggleFlyButton.Text = "ƒêANG BAY"
        toggleFlyButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        statusLabel.Text = "ƒê√£ h·ªìi sinh - ƒêang bay: " .. targetPlayer.Name
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
        
        if flyConnection then
            flyConnection:Disconnect()
        end
        flyConnection = RunService.Heartbeat:Connect(function()
            if isFlying then
                flyToTarget()
            end
        end)
    else
        statusLabel.Text = "ƒê√£ h·ªìi sinh - S·∫µn s√†ng"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    end
end)

-- Khi ch·∫øt
player.CharacterRemoving:Connect(function()
    wasFlyingBeforeDeath = isFlying
    previousTarget = targetPlayer
    
    isFlying = false
    statusLabel.Text = "ƒê√£ ch·∫øt - T·∫°m d·ª´ng"
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 0)
    
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
end)

-- K·∫øt n·ªëi s·ª± ki·ªán
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Kh·ªüi t·∫°o ban ƒë·∫ßu
updatePlayerList()

-- X·ª≠ l√Ω n√∫t b·∫≠t/t·∫Øt menu
toggleButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- X·ª≠ l√Ω n√∫t b·∫≠t/t·∫Øt bay - QUAN TR·ªåNG: M·ªû KH√ìA KHI T·∫ÆT BAY
toggleFlyButton.MouseButton1Click:Connect(function()
    if not targetPlayer then
        statusLabel.Text = "Ch·ªçn target tr∆∞·ªõc!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        return
    end
    
    if not targetPlayer.Character then
        statusLabel.Text = "Target ch∆∞a load!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        return
    end
    
    isFlying = not isFlying
    
    if isFlying then
        toggleFlyButton.Text = "ƒêANG BAY"
        toggleFlyButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        statusLabel.Text = "Bay ƒë·∫øn: " .. targetPlayer.Name
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
        
        if flyConnection then
            flyConnection:Disconnect()
        end
        flyConnection = RunService.Heartbeat:Connect(function()
            if isFlying then
                flyToTarget()
            end
        end)
        
    else
        -- QUAN TR·ªåNG: M·ªû KH√ìA DI CHUY·ªÇN KHI T·∫ÆT BAY
        unlockMovement()
        
        toggleFlyButton.Text = "B·∫¨T BAY"
        toggleFlyButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        statusLabel.Text = "ƒê√£ d·ª´ng bay - C√≥ th·ªÉ di chuy·ªÉn"
        statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
        
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
    end
end)

statusLabel.Text = "S·∫µn s√†ng"
statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)

print("FLY ANT - ƒê√£ s·ª≠a l·ªói kh√¥ng di chuy·ªÉn ƒë∆∞·ª£c - by lolkanhz")
